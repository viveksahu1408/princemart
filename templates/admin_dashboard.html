{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold"><i class="fas fa-tachometer-alt me-2"></i>Analytics Dashboard</h3>
        
        <div class="dropdown me-3 d-inline-block">
    <button class="btn btn-light position-relative" type="button" id="notifDropdown" data-bs-toggle="dropdown">
        <i class="fas fa-bell text-primary" style="font-size: 20px;"></i>
        {% if admin_notifs %}
        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
            <span class="visually-hidden">New alerts</span>
        </span>
        {% endif %}
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="notifDropdown" style="width: 300px;">
        <li><h6 class="dropdown-header">Recent Orders</h6></li>
        {% for notif in admin_notifs %}
        <li>
            <a class="dropdown-item d-flex align-items-center p-2" href="{{ notif.link }}">
                <div class="bg-light rounded-circle p-2 me-2"><i class="fas fa-shopping-bag text-success"></i></div>
                <div class="small">
                    <strong>{{ notif.title }}</strong><br>
                    <span class="text-muted" style="font-size: 11px;">{{ notif.message|truncatechars:30 }}</span>
                    <br><span class="text-muted" style="font-size: 9px;">{{ notif.date|timesince }} ago</span>
                </div>
            </a>
        </li>
        {% empty %}
        <li class="p-3 text-center small text-muted">No new notifications</li>
        {% endfor %}
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-center small text-primary" href="/admin/store/order/">View All Orders</a></li>
    </ul>
</div>

        <div>
            <a href="/admin/" class="btn btn-dark me-2">
                <i class="fas fa-user-shield me-2"></i>Go to Main Admin Panel
            </a>
            <a href="{% url 'export_orders' %}" class="btn btn-success">
                <i class="fas fa-file-excel me-2"></i>Export Excel
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-success shadow-sm h-100" style="border-radius: 15px;">
                <div class="card-body">
                    <h6 class="card-title">Total Revenue</h6>
                    <h2 class="fw-bold">₹{{ total_sales }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary shadow-sm h-100" style="border-radius: 15px;">
                <div class="card-body">
                    <h6 class="card-title">Total Orders</h6>
                    <h2 class="fw-bold">{{ total_orders }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger shadow-sm h-100" style="border-radius: 15px;">
                <div class="card-body">
                    <h6 class="card-title">Stock Available</h6>
                    <h2 class="fw-bold">{{ total_stock }} Pcs</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-dark bg-warning shadow-sm h-100" style="border-radius: 15px;">
                <div class="card-body">
                    <h6 class="card-title">Total Products</h6>
                    <h2 class="fw-bold">{{ total_products }}</h2>
                </div>
            </div>
        </div>
        <!-- <div class="col-md-3 mb-4">
    <a href="{% url 'customer_insights' %}" class="text-decoration-none">
        <div class="card text-white bg-info h-100 shadow">
            <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                <i class="fas fa-search-plus fa-3x mb-3"></i>
                <h5 class="card-title">Search Customer</h5>
                <p class="card-text small">Find History by Name/Mobile</p>
            </div>
        </div>
    </a>
</div> -->

    </div>

    <div class="row">
        <div class="col-md-8 mb-4">
            <div class="card shadow-sm border-0" style="border-radius: 15px;">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-chart-bar me-2"></i>Monthly Sales Report (Last 6 Months)
                </div>
                <div class="card-body">
                    <canvas id="salesChart" height="120"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 15px;">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </div>
                <div class="card-body">
                    <a href="/admin/store/product/add/" class="btn btn-outline-primary w-100 mb-3 text-start">
                        <i class="fas fa-plus-circle me-2"></i>Add New Product
                    </a>
                    <a href="/admin/store/category/add/" class="btn btn-outline-secondary w-100 mb-3 text-start">
                        <i class="fas fa-tags me-2"></i>Add Category
                    </a>
                    <a href="/admin/store/banner/add/" class="btn btn-outline-info w-100 mb-3 text-start">
                        <i class="fas fa-images me-2"></i>Change Home Banner
                    </a>
                    <a href="{% url 'customer_insights' %}" class="btn btn-outline-danger w-100 mb-3 text-start">
                     <i class="fas fa-search-plus me-2"></i>Search Customer
                    </a>
                    <a href="{% url 'admin:store_product_changelist' %}" class="btn btn-outline-success w-100 mb-3 text-start">
                    <i class="fas fa-box-open me-2"></i>Manage Products
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0" style="border-radius: 15px;">
    <div class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center py-3">
        <h5 class="mb-0 fw-bold"><i class="fas fa-list me-2"></i>Order List</h5>
        
        <form method="GET" class="d-flex flex-wrap align-items-center gap-2">
            
            <div>
                <small class="text-muted d-block">Search:</small>
                <input type="text" name="search_query" class="form-control form-control-sm" 
                       placeholder="Name or Mobile..." 
                       value="{{ request.GET.search_query|default:'' }}" 
                       style="width: 150px;">
            </div>

            <div>
                <small class="text-muted d-block">From:</small>
                <input type="date" name="start_date" class="form-control form-control-sm" value="{{ request.GET.start_date }}">
            </div>
            <div>
                <small class="text-muted d-block">To:</small>
                <input type="date" name="end_date" class="form-control form-control-sm" value="{{ request.GET.end_date }}">
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{% url 'admin_dashboard' %}" class="btn btn-sm btn-outline-secondary">Reset</a>
            </div>
        </form>
    </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer Details</th>
                            <th>Items Purchased</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                            <th>Status Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td><strong>#{{ order.id }}</strong></td>
                            <td>{{ order.date }}</td>
                            <td>
                                <strong>{{ order.customer_name }}</strong><br>
                                <span class="text-muted small"><i class="fas fa-phone"></i> {{ order.customer_phone }}</span><br>
                                <span class="text-muted small"><i class="fas fa-map-marker-alt"></i> {{ order.customer_address|truncatechars:30 }}</span>
                            </td>
                            <td>
                                <ul class="list-unstyled mb-0 small">
                                    {% for item in order.orderitem_set.all %}
                                    <li>{{ item.quantity }} x {{ item.product.name }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td class="fw-bold text-success">₹{{ order.total_amount }}</td>
                            <td>
                                {% if order.status %}
                                    <span class="badge bg-success">Delivered</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'packing_list' order.id %}" class="btn btn-sm btn-dark" title="Pack List"><i class="fas fa-box"></i></a>
                                <a href="{% url 'order_invoice' order.id %}" class="btn btn-sm btn-primary" title="Invoice"><i class="fas fa-file-invoice"></i></a>
                            </td>
                            <td>
    {% if order.status %}
        <a href="{% url 'admin_toggle_status' order.id %}" class="btn btn-sm btn-success" title="Mark as Pending">
            <i class="fas fa-check-circle"></i> Done
        </a>
    {% else %}
        <a href="{% url 'admin_toggle_status' order.id %}" class="btn btn-sm btn-outline-secondary" title="Mark as Delivered/Picked Up">
            <i class="fas fa-square"></i> Mark Done
        </a>
    {% endif %}
</td>

                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">No orders found in this date range.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('salesChart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: 'Monthly Sales (₹)',
                data: {{ sales|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
<div style="height: 100px;"></div>
{% endblock %}